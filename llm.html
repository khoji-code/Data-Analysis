<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>5327099297b74fe98522c4b32cdb4a6e</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<section
id="specialized-business-intelligence-assistant-via-llm-fine-tuning"
class="cell markdown" id="ZmnN5CTHQzWd">
<h1>Specialized Business Intelligence Assistant via LLM Fine-Tuning</h1>
</section>
<div class="cell markdown" id="vmF6BQQqSQ4z">
<hr />
<h3 id="project-overview"><strong>Project Overview</strong></h3>
<ul>
<li><strong>Goal:</strong> To fine-tune a general-purpose Large Language
Model (LLM), Google's Gemma-2B-it, to become a specialized tool for
summarizing business communications.</li>
<li><strong>Dataset:</strong> Utilizes the Enron Email Dataset from
Kaggle, containing a large corpus of real-world business emails.</li>
<li><strong>Methodology:</strong> The project involves parsing a
significant sample of emails from the Enron dataset to create an
instructional dataset for fine-tuning. The Gemma-2B-it model is then
efficiently fine-tuned using QLoRA (Quantized Low-Rank Adaptation) and
the SFTTrainer from the TRL library. The performance of the fine-tuned
model is evaluated by comparing its summarization capabilities on a test
email against the original model's output.</li>
<li><strong>Key Results:</strong> The fine-tuned model produces a
significantly more coherent, relevant, and concise summary of a test
email compared to its general-purpose counterpart. This demonstrates the
effectiveness of fine-tuning for creating a specialized, high-value
business tool.</li>
</ul>
<hr />
<h3 id="purpose"><strong>Purpose</strong></h3>
<ul>
<li><strong>Automate Business Intelligence:</strong> To create a
specialized AI assistant that can automate the process of summarizing
and extracting key information from large volumes of business
communications, such as emails.</li>
<li><strong>Enhance Decision-Making:</strong> To provide executives and
employees with quick, accurate summaries of important communications,
enabling them to make faster, more informed decisions without having to
manually read through lengthy email chains.</li>
<li><strong>Improve Operational Efficiency:</strong> To save significant
time and resources in tasks like legal discovery, compliance checks, and
daily reporting by automating the summarization process. This transforms
a general LLM into a powerful, domain-specific productivity tool.</li>
</ul>
</div>
<section id="install-libraries" class="cell markdown" id="gE4F0AZCSYtA">
<h2>Install Libraries</h2>
</section>
<div class="cell code" data-execution_count="7" id="PojmYAfrSjyD">
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>q kagglehub</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>q <span class="op">-</span>U transformers datasets accelerate peft bitsandbytes</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>q trl<span class="op">==</span><span class="fl">0.12.0</span></span></code></pre></div>
</div>
<section id="setup-authentication-and-download-data"
class="cell markdown" id="ODntOS4aSptf">
<h2>Setup Authentication and Download Data</h2>
</section>
<div class="cell code" data-execution_count="8"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:242}"
id="dTLjCR_4TBtS" data-outputId="f74b5b74-6863-4d9f-9a2f-69ba1ac54736">
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> kagglehub</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> google.colab <span class="im">import</span> files</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> getpass <span class="co"># To securely get user input for the token</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Kaggle Authentication</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># This block prompts you to upload your kaggle.json file to authenticate.</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Please upload your kaggle.json file.&quot;</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="st">&#39;/root/.kaggle&#39;</span>):</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    os.makedirs(<span class="st">&#39;/root/.kaggle&#39;</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>uploaded <span class="op">=</span> files.upload()</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> fn <span class="kw">in</span> uploaded.keys():</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>mv {fn} <span class="op">/</span>root<span class="op">/</span>.kaggle<span class="op">/</span>kaggle.json</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>chmod <span class="dv">600</span> <span class="op">/</span>root<span class="op">/</span>.kaggle<span class="op">/</span>kaggle.json</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Kaggle authentication successful.&quot;</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Hugging Face Authentication</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="co"># A secure password box will appear for your token.</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    hf_token <span class="op">=</span> getpass.getpass(<span class="st">&#39;Please enter your Hugging Face token: &#39;</span>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    os.environ[<span class="st">&quot;HF_TOKEN&quot;</span>] <span class="op">=</span> hf_token</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Hugging Face token loaded successfully.&quot;</span>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Could not get token: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Download and Unzip the Dataset</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="co"># We define a directory name to make the path consistent.</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>DATA_DIR <span class="op">=</span> <span class="st">&quot;/content/download&quot;</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">Downloading Enron dataset...&quot;</span>)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="co"># The download function returns the path to the directory containing the downloaded file.</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>download_path <span class="op">=</span> kagglehub.dataset_download(<span class="st">&quot;wcukierski/enron-email-dataset&quot;</span>)</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Dataset downloaded to: </span><span class="sc">{</span>download_path<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>ls <span class="op">/</span>kaggle<span class="op">/</span><span class="bu">input</span><span class="op">/</span>enron<span class="op">-</span>email<span class="op">-</span>dataset</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Correctly locate and unzip the file using a wildcard.</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>cp <span class="st">&quot;</span><span class="sc">{download_path}</span><span class="st">/emails.csv&quot;</span>  {DATA_DIR}</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Dataset successfully moved into the &#39;</span><span class="sc">{</span>DATA_DIR<span class="sc">}</span><span class="ss">&#39; directory.&quot;</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Please upload your kaggle.json file.
</code></pre>
</div>
<div class="output display_data">

     <input type="file" id="files-ac1d926a-b7e7-4406-b33e-f86e20c4f3ad" name="files[]" multiple disabled
        style="border:none" />
     <output id="result-ac1d926a-b7e7-4406-b33e-f86e20c4f3ad">
      Upload widget is only available when the cell has been executed in the
      current browser session. Please rerun this cell to enable.
      </output>
      <script>// Copyright 2017 Google LLC
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/**
 * @fileoverview Helpers for google.colab Python module.
 */
(function(scope) {
function span(text, styleAttributes = {}) {
  const element = document.createElement('span');
  element.textContent = text;
  for (const key of Object.keys(styleAttributes)) {
    element.style[key] = styleAttributes[key];
  }
  return element;
}

// Max number of bytes which will be uploaded at a time.
const MAX_PAYLOAD_SIZE = 100 * 1024;

function _uploadFiles(inputId, outputId) {
  const steps = uploadFilesStep(inputId, outputId);
  const outputElement = document.getElementById(outputId);
  // Cache steps on the outputElement to make it available for the next call
  // to uploadFilesContinue from Python.
  outputElement.steps = steps;

  return _uploadFilesContinue(outputId);
}

// This is roughly an async generator (not supported in the browser yet),
// where there are multiple asynchronous steps and the Python side is going
// to poll for completion of each step.
// This uses a Promise to block the python side on completion of each step,
// then passes the result of the previous step as the input to the next step.
function _uploadFilesContinue(outputId) {
  const outputElement = document.getElementById(outputId);
  const steps = outputElement.steps;

  const next = steps.next(outputElement.lastPromiseValue);
  return Promise.resolve(next.value.promise).then((value) => {
    // Cache the last promise value to make it available to the next
    // step of the generator.
    outputElement.lastPromiseValue = value;
    return next.value.response;
  });
}

/**
 * Generator function which is called between each async step of the upload
 * process.
 * @param {string} inputId Element ID of the input file picker element.
 * @param {string} outputId Element ID of the output display.
 * @return {!Iterable<!Object>} Iterable of next steps.
 */
function* uploadFilesStep(inputId, outputId) {
  const inputElement = document.getElementById(inputId);
  inputElement.disabled = false;

  const outputElement = document.getElementById(outputId);
  outputElement.innerHTML = '';

  const pickedPromise = new Promise((resolve) => {
    inputElement.addEventListener('change', (e) => {
      resolve(e.target.files);
    });
  });

  const cancel = document.createElement('button');
  inputElement.parentElement.appendChild(cancel);
  cancel.textContent = 'Cancel upload';
  const cancelPromise = new Promise((resolve) => {
    cancel.onclick = () => {
      resolve(null);
    };
  });

  // Wait for the user to pick the files.
  const files = yield {
    promise: Promise.race([pickedPromise, cancelPromise]),
    response: {
      action: 'starting',
    }
  };

  cancel.remove();

  // Disable the input element since further picks are not allowed.
  inputElement.disabled = true;

  if (!files) {
    return {
      response: {
        action: 'complete',
      }
    };
  }

  for (const file of files) {
    const li = document.createElement('li');
    li.append(span(file.name, {fontWeight: 'bold'}));
    li.append(span(
        `(${file.type || 'n/a'}) - ${file.size} bytes, ` +
        `last modified: ${
            file.lastModifiedDate ? file.lastModifiedDate.toLocaleDateString() :
                                    'n/a'} - `));
    const percent = span('0% done');
    li.appendChild(percent);

    outputElement.appendChild(li);

    const fileDataPromise = new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        resolve(e.target.result);
      };
      reader.readAsArrayBuffer(file);
    });
    // Wait for the data to be ready.
    let fileData = yield {
      promise: fileDataPromise,
      response: {
        action: 'continue',
      }
    };

    // Use a chunked sending to avoid message size limits. See b/62115660.
    let position = 0;
    do {
      const length = Math.min(fileData.byteLength - position, MAX_PAYLOAD_SIZE);
      const chunk = new Uint8Array(fileData, position, length);
      position += length;

      const base64 = btoa(String.fromCharCode.apply(null, chunk));
      yield {
        response: {
          action: 'append',
          file: file.name,
          data: base64,
        },
      };

      let percentDone = fileData.byteLength === 0 ?
          100 :
          Math.round((position / fileData.byteLength) * 100);
      percent.textContent = `${percentDone}% done`;

    } while (position < fileData.byteLength);
  }

  // All done.
  yield {
    response: {
      action: 'complete',
    }
  };
}

scope.google = scope.google || {};
scope.google.colab = scope.google.colab || {};
scope.google.colab._files = {
  _uploadFiles,
  _uploadFilesContinue,
};
})(self);
</script> 
</div>
<div class="output stream stdout">
<pre><code>Saving kaggle.json to kaggle.json
Kaggle authentication successful.
Please enter your Hugging Face token: ··········
Hugging Face token loaded successfully.

Downloading Enron dataset...
Dataset downloaded to: /kaggle/input/enron-email-dataset
emails.csv
Dataset successfully moved into the &#39;/content/download&#39; directory.
</code></pre>
</div>
</div>
<section id="exploratory-data-analysis-eda-and-data-preparation"
class="cell markdown" id="ApvkPq0rTWlf">
<h2>Exploratory Data Analysis (EDA) and Data Preparation</h2>
</section>
<div class="cell code" data-execution_count="9"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="8Kn1qjD2XtSm" data-outputId="bff3c199-b2ca-4bac-c7e9-02469d73bb32">
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> email <span class="co"># Python&#39;s built-in library for parsing email messages</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">Loading and parsing emails...&quot;</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Point to the directory where you unzipped the data in Step 2.</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>file_path <span class="op">=</span> os.path.join(DATA_DIR, <span class="st">&#39;emails.csv&#39;</span>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(file_path):</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f&quot;ERROR: The file &#39;</span><span class="sc">{</span>file_path<span class="sc">}</span><span class="ss">&#39; was not found. &quot;</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;This might happen if the download or unzip process failed. Please check the output of the previous cell.&quot;</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co"># The dataset is very large. We&#39;ll work with a sizable, representative sample for efficiency.</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>SAMPLE_SIZE <span class="op">=</span> <span class="dv">20000</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>df_emails <span class="op">=</span> pd.read_csv(file_path, nrows<span class="op">=</span>SAMPLE_SIZE)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Email Parsing Function ---</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_email(raw_message):</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>        msg <span class="op">=</span> email.message_from_string(raw_message)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>        body <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> msg.is_multipart():</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> part <span class="kw">in</span> msg.walk():</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>                ctype <span class="op">=</span> part.get_content_type()</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>                cdispo <span class="op">=</span> <span class="bu">str</span>(part.get(<span class="st">&#39;Content-Disposition&#39;</span>))</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> ctype <span class="op">==</span> <span class="st">&#39;text/plain&#39;</span> <span class="kw">and</span> <span class="st">&#39;attachment&#39;</span> <span class="kw">not</span> <span class="kw">in</span> cdispo:</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>                    body <span class="op">=</span> part.get_payload(decode<span class="op">=</span><span class="va">True</span>).decode(<span class="st">&#39;utf-8&#39;</span>, <span class="st">&#39;ignore&#39;</span>)</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>            body <span class="op">=</span> msg.get_payload(decode<span class="op">=</span><span class="va">True</span>).decode(<span class="st">&#39;utf-8&#39;</span>, <span class="st">&#39;ignore&#39;</span>)</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;subject&#39;</span>: msg[<span class="st">&#39;subject&#39;</span>],</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;from&#39;</span>: msg[<span class="st">&#39;from&#39;</span>],</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;to&#39;</span>: msg[<span class="st">&#39;to&#39;</span>],</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;body&#39;</span>: body</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>tqdm.pandas()</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>parsed_emails <span class="op">=</span> df_emails[<span class="st">&#39;message&#39;</span>].progress_apply(parse_email)</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>df_parsed <span class="op">=</span> pd.DataFrame(parsed_emails.tolist())</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>df_final <span class="op">=</span> pd.concat([df_emails[[<span class="st">&#39;file&#39;</span>]], df_parsed], axis<span class="op">=</span><span class="dv">1</span>).dropna(subset<span class="op">=</span>[<span class="st">&#39;body&#39;</span>, <span class="st">&#39;subject&#39;</span>])</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">Successfully parsed </span><span class="sc">{</span><span class="bu">len</span>(df_final)<span class="sc">}</span><span class="ss"> emails.&quot;</span>)</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Sample of parsed data:&quot;</span>)</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_final.head())</span></code></pre></div>
<div class="output stream stdout">
<pre><code>
Loading and parsing emails...
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>100%|██████████| 20000/20000 [00:02&lt;00:00, 8523.63it/s]
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>
Successfully parsed 20000 emails.
Sample of parsed data:
                       file    subject                     from  \
0     allen-p/_sent_mail/1.             phillip.allen@enron.com   
1    allen-p/_sent_mail/10.        Re:  phillip.allen@enron.com   
2   allen-p/_sent_mail/100.   Re: test  phillip.allen@enron.com   
3  allen-p/_sent_mail/1000.             phillip.allen@enron.com   
4  allen-p/_sent_mail/1001.  Re: Hello  phillip.allen@enron.com   

                        to                                               body  
0     tim.belden@enron.com                          Here is our forecast\n\n   
1  john.lavorato@enron.com  Traveling to have a business meeting takes the...  
2   leah.arsdall@enron.com                     test successful.  way to go!!!  
3    randall.gay@enron.com  Randy,\n\n Can you send me a schedule of the s...  
4     greg.piper@enron.com                Let&#39;s shoot for Tuesday at 11:45.    
</code></pre>
</div>
</div>
<section id="eda-visualization" class="cell markdown" id="RH_Qv-pQX_l5">
<h2>EDA Visualization</h2>
</section>
<div class="cell code" data-execution_count="10"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:562}"
id="eImuI3ynYCqW" data-outputId="e71ab857-15c4-4332-bcf7-006a51c339ca">
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">Visualizing top senders...&quot;</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>top_senders <span class="op">=</span> df_final[<span class="st">&#39;from&#39;</span>].value_counts().nlargest(<span class="dv">10</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">7</span>))</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>sns.barplot(x<span class="op">=</span>top_senders.values, y<span class="op">=</span>top_senders.index, palette<span class="op">=</span><span class="st">&#39;viridis&#39;</span>,hue<span class="op">=</span>top_senders.index)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;Top 10 Email Senders in the Enron Sample&#39;</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;Number of Emails Sent&#39;</span>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;Sender&#39;</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>
Visualizing top senders...
</code></pre>
</div>
<div class="output display_data">
<p><img
src="https://khoji-code.github.io/Data-Science-AI-for-Business-Portfolio/4f2e5b933eaec54ae10f4484687418abcbc701e0.png" /></p>
</div>
</div>
<section id="prepare-data-for-fine-tuning" class="cell markdown"
id="ShWF3h8qYEwG">
<h2>Prepare Data for Fine-Tuning</h2>
</section>
<div class="cell code" data-execution_count="11"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="fnMs3YpGYYET" data-outputId="00460e5c-40e1-4fac-cd92-55cd5dbb52ad">
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_instructional_dataset(df):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    instructions <span class="op">=</span> []</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>        body <span class="op">=</span> <span class="bu">str</span>(row[<span class="st">&#39;body&#39;</span>]).strip().replace(<span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>, <span class="st">&#39; &#39;</span>).replace(<span class="st">&#39;</span><span class="ch">\r</span><span class="st">&#39;</span>, <span class="st">&#39; &#39;</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        subject <span class="op">=</span> <span class="bu">str</span>(row[<span class="st">&#39;subject&#39;</span>]).strip()</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(body) <span class="op">&gt;</span> <span class="dv">150</span> <span class="kw">and</span> <span class="bu">len</span>(subject) <span class="op">&gt;</span> <span class="dv">5</span>:</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>            text <span class="op">=</span> <span class="ss">f&quot;&lt;s&gt;[INST] Summarize the following email: </span><span class="sc">{</span>body<span class="sc">}</span><span class="ss"> [/INST] </span><span class="sc">{</span>subject<span class="sc">}</span><span class="ss"> &lt;/s&gt;&quot;</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>            instructions.append({<span class="st">&#39;text&#39;</span>: text})</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> instructions</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>instruction_data <span class="op">=</span> create_instructional_dataset(df_final.head(<span class="dv">5000</span>))</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">Created </span><span class="sc">{</span><span class="bu">len</span>(instruction_data)<span class="sc">}</span><span class="ss"> instructions for fine-tuning.&quot;</span>)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Example instruction:&quot;</span>)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(instruction_data[<span class="dv">0</span>][<span class="st">&#39;text&#39;</span>])</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datasets <span class="im">import</span> Dataset</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>fine_tuning_dataset <span class="op">=</span> Dataset.from_list(instruction_data)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>
Created 2809 instructions for fine-tuning.
Example instruction:
&lt;s&gt;[INST] Summarize the following email: 1. login:  pallen pw: ke9davis   I don&#39;t think these are required by the ISP     2.  static IP address   IP: 64.216.90.105  Sub: 255.255.255.248  gate: 64.216.90.110  DNS: 151.164.1.8    3.  Company: 0413         RC:  105891 [/INST] Re: High Speed Internet Access &lt;/s&gt;
</code></pre>
</div>
</div>
<section id="configure-and-load-the-advanced-model-gemma-2b-with-qlora"
class="cell markdown" id="B2uaoE7sYYhb">
<h2>Configure and Load the Advanced Model (Gemma-2B with QLoRA)</h2>
</section>
<div class="cell code" data-execution_count="12"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:554,&quot;referenced_widgets&quot;:[&quot;9ef17598038449f19bc4c72db82d0fd6&quot;,&quot;9f4aac6c50674c2d944dc63c92aa2ca6&quot;,&quot;8afef72acf1d4bfab3fb9f6f52b7a1ba&quot;,&quot;44bed2fc40d04178a4d9f76c2e226392&quot;,&quot;9d393c2e60df4af195b7bbdaafbac68a&quot;,&quot;4290996918d447c98b3a1dbee3484951&quot;,&quot;ec77504e834d4eb284df060edf458ec3&quot;,&quot;a31992a2e6eb4378bdf112bdcedb7279&quot;,&quot;60cc34feb9904fe699134aeb729c35e4&quot;,&quot;19c8892b77a947fb8eb609ffdcf2f6e2&quot;,&quot;553cc140bbb9499a8c1a694a29d4029c&quot;,&quot;f58361c8809e49dba5fbd31e87e38737&quot;,&quot;2e81059db86a47ecab17e98cf9ffd14b&quot;,&quot;4d001f3f405b479d9518ffa54a9372c2&quot;,&quot;998573a5bb964216ab1cf3c308d07cc2&quot;,&quot;09d04442b4774495a693fb6dbad93f8e&quot;,&quot;5a46f808fb63478db202ab6c503ea03b&quot;,&quot;78de243cba2d44d293a79065621db2bf&quot;,&quot;f0e2030a20d84df18e8b1ccbc903c136&quot;,&quot;2e500e55393b4f7abdbae41439d7d634&quot;,&quot;2f82f19899ab4a58b48c441834990ff8&quot;,&quot;17efc4d6c3ec4294ace7722af25e0a86&quot;,&quot;fa0e5894b8c24fd1a24f989a93504440&quot;,&quot;cfac623c5db340f08b480ec9a1f171fb&quot;,&quot;5ae7d340dd4a4671ad579a08615552ba&quot;,&quot;bdbc878fff3b41fd9feec8190b71be3b&quot;,&quot;3967c53540f7415aa2bb412137487055&quot;,&quot;f08a9e4fc958479a8fe6f056d4e8a415&quot;,&quot;855319bc8ba74ce9b5765b9d66f63749&quot;,&quot;df6934e11587462d8b9f210316c7eeb1&quot;,&quot;d98b590fc8a5471891b4bc7d5a2d159f&quot;,&quot;9ceeeb4924524fbcbd6c1b34b4c29d6d&quot;,&quot;c305b24680fe46769249482d2c1e0e18&quot;,&quot;9e2256598e3e40c7adf98ebdd8487108&quot;,&quot;6c832c6798a94d4b806ddc2f45a4e601&quot;,&quot;e7c4f28b4b0b4d5495088c726fb93893&quot;,&quot;2746890d2e9b43a9a0934b5722908cfb&quot;,&quot;a06dfa10d91341f99a1667f34c0ca0a0&quot;,&quot;b52ecb08fbe14a728d0ec15053fd33b4&quot;,&quot;57556ff1f29147b3b93add352f736de1&quot;,&quot;12cdd99661b94121af9a01ab421ec2e4&quot;,&quot;3c4fb994d8d54d01875eeada45317c44&quot;,&quot;7a487cb191214fd383b38c236023247f&quot;,&quot;ef77b903ab1845d7b65375a95a0116e7&quot;,&quot;16a576cc72d948f8b0a174f5805e9c50&quot;,&quot;b626e74fbb05480a8102db0f76d7acd8&quot;,&quot;0b73ad6de1724c43aebf7944bb712fa4&quot;,&quot;167ad519e9414ff0bc4cfabab58a0132&quot;,&quot;684c9848d2c04c47a33cad1990c170d5&quot;,&quot;effb55ddee3c4072a643809c6dd56aea&quot;,&quot;1556995e9fbe421b9345671684b0886e&quot;,&quot;ae8ccfdda7f44c22909370c042aced9d&quot;,&quot;41f6ac75e0e04d1aaa2e88e082c20ef9&quot;,&quot;bfa1b825228848648093d86986a835e4&quot;,&quot;dd3fb382f4c54583a739e0cdd8103ee2&quot;,&quot;70b24f38fd8c422bbf5b77edbafc135b&quot;,&quot;ffd68a3f4fb24cbbb387b1a9985ba79e&quot;,&quot;e5a6eb2b9cc442e2983e40ea96546440&quot;,&quot;28d75d641f1e4126955bb9a0cd8350b9&quot;,&quot;1fc9b1d173c1449da8aa63025dc6ce92&quot;,&quot;d1b15b92a05f43b0b6abaa33e50473e5&quot;,&quot;94ab44a87b8741d59b0761a4711c869c&quot;,&quot;9fcf0c1d6c0142bd95c392235b690db3&quot;,&quot;3a13a663a34047099d4fa22ff69d4cc8&quot;,&quot;adbd9eaf142d443ea0bc6982a1189493&quot;,&quot;2ddc2a3069ff4f59ae03f34cded142af&quot;,&quot;f6ce407d9ada4cc2a5cdb9153bc56dd1&quot;,&quot;5ce73302d55b4eda9013b3d1a40d252c&quot;,&quot;4022bfcd62ef4339847ceca2e266d96c&quot;,&quot;3fa152540ece4fcab51f483856aa7ac4&quot;,&quot;38ca50db33084c9e8922f129c9550439&quot;,&quot;a27372dad44846c18f8db1bfdd61e2e0&quot;,&quot;a9d30a3e83c2477b8157f79eb0402a4f&quot;,&quot;6a600ba8ec89440f9821fb4b475541ee&quot;,&quot;cf2056bc3f364d4b9aba862ccad0bf7e&quot;,&quot;3cb33ea125f745d782996edfc872e8c3&quot;,&quot;8d80e8103f974436aea0668d8b066b98&quot;,&quot;fbc5ff8018024940a136553c29e4c64a&quot;,&quot;6d9627052e3c4ad5a236cb58fc16c655&quot;,&quot;51e4f5e011d6446c9b2c911ffc5e3e0d&quot;,&quot;6006bc0f064e436c9be6f5758c2159b0&quot;,&quot;339b952d91874e399bef34f5b81a92ca&quot;,&quot;2f108775c03b4dbaa85a59e53e7f15d2&quot;,&quot;17d2362fc465476fbd8be6ad2c2cd8ae&quot;,&quot;d3dd698613264387ae45dc9a4f8fad5c&quot;,&quot;3afe13af84194c30b6862b121e761241&quot;,&quot;5f65be1529f54ab79a17d077458775a5&quot;,&quot;0ccd6a47d6c04c50bebc55f3afb183de&quot;,&quot;c1ccd007f78f41e782148178353d1d27&quot;,&quot;2910480685cb4043a78c32f1efc56f3d&quot;,&quot;464e2fcc48f1434886f5c689257b494a&quot;,&quot;beac9c38328a4539a7f55a43ac44d77c&quot;,&quot;a539347fe95846d699f112dda6560bc8&quot;,&quot;daa0402b09eb4d62b343e9fc236250e8&quot;,&quot;c60416b2809a47a38e2deac63a48e620&quot;,&quot;8f5a95108daa4bec929729dbdb0034fc&quot;,&quot;4cd796203e7a489faa97240656d3facb&quot;,&quot;18b11f1470df4edab98746c08f6787ff&quot;,&quot;ed5588136fab4d39a94a6f1399dacffe&quot;,&quot;e8fccc91a1f24dcea3475a49f94fd6bc&quot;,&quot;4f7b32a740b54f37be3057adf6d760da&quot;,&quot;25601a0c177949ad90352e31f09f7e50&quot;,&quot;eee33917f2c34ffdb7389be5deea3578&quot;,&quot;fd0f4d5227314cddb47e20f139ae6a1e&quot;,&quot;e595e8cb2eba4913945190e7bbc1b431&quot;,&quot;91debcf37b6e4dc2b2d4f28b1c5da1df&quot;,&quot;f0febf06cd344e1b9d6caadd820831c3&quot;,&quot;310d4301f252435b9a852c1963880910&quot;,&quot;226c5776331c4bd8b09a2ae3eaf45615&quot;,&quot;9d9165dc46d8495ea3edf6b413e44a4d&quot;,&quot;9f1d1d14321843089eb062814707b88c&quot;,&quot;ca42f6fe00ab4befb9546060dc212867&quot;,&quot;662295efa4b940638a850de8ced3a794&quot;,&quot;67383ace80b9408f996b8ec3aa3ad84d&quot;,&quot;9ec2d13b51c24f54bc6867b3f1effa8b&quot;,&quot;6c225944cfd34d64a1c16b31d44a5ebb&quot;,&quot;09fc4b9b0ce14f6995664cc1c12f03cf&quot;,&quot;7c0eaa075f90459ca5dd31e2e1cd182f&quot;,&quot;241f821bf8834f479366b3901e88d856&quot;,&quot;40adbafe7cc442eeac5369430e9c7a0a&quot;,&quot;30bc2e6f512549b18579f1e604105abd&quot;]}"
id="55ixrGxSYiOT" data-outputId="2532bea3-f5d9-4c35-b580-e39ecafa9c5a">
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> AutoTokenizer, AutoModelForCausalLM, BitsAndBytesConfig</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> peft <span class="im">import</span> LoraConfig</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Model and Tokenizer ---</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>model_id <span class="op">=</span> <span class="st">&quot;google/gemma-2b-it&quot;</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co"># --- QLoRA Configuration ---</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>bnb_config <span class="op">=</span> BitsAndBytesConfig(</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    load_in_4bit<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    bnb_4bit_quant_type<span class="op">=</span><span class="st">&quot;nf4&quot;</span>,</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    bnb_4bit_compute_dtype<span class="op">=</span>torch.bfloat16</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Load the Tokenizer and Model (ONCE!) ---</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">Loading model and tokenizer...&quot;</span>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>tokenizer <span class="op">=</span> AutoTokenizer.from_pretrained(model_id, token<span class="op">=</span>os.environ[<span class="st">&quot;HF_TOKEN&quot;</span>])</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> AutoModelForCausalLM.from_pretrained(</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    model_id,</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    quantization_config<span class="op">=</span>bnb_config,</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    device_map<span class="op">=</span>{<span class="st">&quot;&quot;</span>:<span class="dv">0</span>}, <span class="co"># Automatically map the model to the available GPU</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    token<span class="op">=</span>os.environ[<span class="st">&quot;HF_TOKEN&quot;</span>]</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Model loaded successfully in 4-bit precision.&quot;</span>)</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="co"># --- LoRA Configuration ---</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>peft_config <span class="op">=</span> LoraConfig(</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    r<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    target_modules<span class="op">=</span>[<span class="st">&quot;q_proj&quot;</span>, <span class="st">&quot;k_proj&quot;</span>, <span class="st">&quot;v_proj&quot;</span>, <span class="st">&quot;o_proj&quot;</span>],</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    task_type<span class="op">=</span><span class="st">&quot;CAUSAL_LM&quot;</span>,</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>
Loading model and tokenizer...
</code></pre>
</div>
<div class="output display_data">
<div class="sourceCode" id="cb15"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;model_id&quot;</span><span class="fu">:</span><span class="st">&quot;9ef17598038449f19bc4c72db82d0fd6&quot;</span><span class="fu">,</span><span class="dt">&quot;version_major&quot;</span><span class="fu">:</span><span class="dv">2</span><span class="fu">,</span><span class="dt">&quot;version_minor&quot;</span><span class="fu">:</span><span class="dv">0</span><span class="fu">}</span></span></code></pre></div>
</div>
<div class="output stream stderr">
<pre><code>/usr/local/lib/python3.12/dist-packages/huggingface_hub/utils/_auth.py:94: UserWarning: 
The secret `HF_TOKEN` does not exist in your Colab secrets.
To authenticate with the Hugging Face Hub, create a token in your settings tab (https://huggingface.co/settings/tokens), set it as secret in your Google Colab and restart your session.
You will be able to reuse this secret in all of your notebooks.
Please note that authentication is recommended but still optional to access public models or datasets.
  warnings.warn(
</code></pre>
</div>
<div class="output display_data">
<div class="sourceCode" id="cb17"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;model_id&quot;</span><span class="fu">:</span><span class="st">&quot;f58361c8809e49dba5fbd31e87e38737&quot;</span><span class="fu">,</span><span class="dt">&quot;version_major&quot;</span><span class="fu">:</span><span class="dv">2</span><span class="fu">,</span><span class="dt">&quot;version_minor&quot;</span><span class="fu">:</span><span class="dv">0</span><span class="fu">}</span></span></code></pre></div>
</div>
<div class="output display_data">
<div class="sourceCode" id="cb18"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;model_id&quot;</span><span class="fu">:</span><span class="st">&quot;fa0e5894b8c24fd1a24f989a93504440&quot;</span><span class="fu">,</span><span class="dt">&quot;version_major&quot;</span><span class="fu">:</span><span class="dv">2</span><span class="fu">,</span><span class="dt">&quot;version_minor&quot;</span><span class="fu">:</span><span class="dv">0</span><span class="fu">}</span></span></code></pre></div>
</div>
<div class="output display_data">
<div class="sourceCode" id="cb19"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;model_id&quot;</span><span class="fu">:</span><span class="st">&quot;9e2256598e3e40c7adf98ebdd8487108&quot;</span><span class="fu">,</span><span class="dt">&quot;version_major&quot;</span><span class="fu">:</span><span class="dv">2</span><span class="fu">,</span><span class="dt">&quot;version_minor&quot;</span><span class="fu">:</span><span class="dv">0</span><span class="fu">}</span></span></code></pre></div>
</div>
<div class="output display_data">
<div class="sourceCode" id="cb20"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;model_id&quot;</span><span class="fu">:</span><span class="st">&quot;16a576cc72d948f8b0a174f5805e9c50&quot;</span><span class="fu">,</span><span class="dt">&quot;version_major&quot;</span><span class="fu">:</span><span class="dv">2</span><span class="fu">,</span><span class="dt">&quot;version_minor&quot;</span><span class="fu">:</span><span class="dv">0</span><span class="fu">}</span></span></code></pre></div>
</div>
<div class="output display_data">
<div class="sourceCode" id="cb21"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;model_id&quot;</span><span class="fu">:</span><span class="st">&quot;70b24f38fd8c422bbf5b77edbafc135b&quot;</span><span class="fu">,</span><span class="dt">&quot;version_major&quot;</span><span class="fu">:</span><span class="dv">2</span><span class="fu">,</span><span class="dt">&quot;version_minor&quot;</span><span class="fu">:</span><span class="dv">0</span><span class="fu">}</span></span></code></pre></div>
</div>
<div class="output display_data">
<div class="sourceCode" id="cb22"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;model_id&quot;</span><span class="fu">:</span><span class="st">&quot;f6ce407d9ada4cc2a5cdb9153bc56dd1&quot;</span><span class="fu">,</span><span class="dt">&quot;version_major&quot;</span><span class="fu">:</span><span class="dv">2</span><span class="fu">,</span><span class="dt">&quot;version_minor&quot;</span><span class="fu">:</span><span class="dv">0</span><span class="fu">}</span></span></code></pre></div>
</div>
<div class="output display_data">
<div class="sourceCode" id="cb23"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;model_id&quot;</span><span class="fu">:</span><span class="st">&quot;fbc5ff8018024940a136553c29e4c64a&quot;</span><span class="fu">,</span><span class="dt">&quot;version_major&quot;</span><span class="fu">:</span><span class="dv">2</span><span class="fu">,</span><span class="dt">&quot;version_minor&quot;</span><span class="fu">:</span><span class="dv">0</span><span class="fu">}</span></span></code></pre></div>
</div>
<div class="output display_data">
<div class="sourceCode" id="cb24"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;model_id&quot;</span><span class="fu">:</span><span class="st">&quot;c1ccd007f78f41e782148178353d1d27&quot;</span><span class="fu">,</span><span class="dt">&quot;version_major&quot;</span><span class="fu">:</span><span class="dv">2</span><span class="fu">,</span><span class="dt">&quot;version_minor&quot;</span><span class="fu">:</span><span class="dv">0</span><span class="fu">}</span></span></code></pre></div>
</div>
<div class="output display_data">
<div class="sourceCode" id="cb25"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;model_id&quot;</span><span class="fu">:</span><span class="st">&quot;e8fccc91a1f24dcea3475a49f94fd6bc&quot;</span><span class="fu">,</span><span class="dt">&quot;version_major&quot;</span><span class="fu">:</span><span class="dv">2</span><span class="fu">,</span><span class="dt">&quot;version_minor&quot;</span><span class="fu">:</span><span class="dv">0</span><span class="fu">}</span></span></code></pre></div>
</div>
<div class="output display_data">
<div class="sourceCode" id="cb26"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;model_id&quot;</span><span class="fu">:</span><span class="st">&quot;9f1d1d14321843089eb062814707b88c&quot;</span><span class="fu">,</span><span class="dt">&quot;version_major&quot;</span><span class="fu">:</span><span class="dv">2</span><span class="fu">,</span><span class="dt">&quot;version_minor&quot;</span><span class="fu">:</span><span class="dv">0</span><span class="fu">}</span></span></code></pre></div>
</div>
<div class="output stream stdout">
<pre><code>Model loaded successfully in 4-bit precision.
</code></pre>
</div>
</div>
<section id="fine-tune-the-model" class="cell markdown"
id="55JraWG2Yk3Y">
<h2>Fine-Tune the Model</h2>
</section>
<div class="cell code" data-execution_count="13"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:952,&quot;referenced_widgets&quot;:[&quot;3b12a484675e4cfcb626cae7f8e950af&quot;,&quot;7db1ecd518664cf7bb06a127d28c0b0b&quot;,&quot;668ede0377ff4fcc9f644256cf163b82&quot;,&quot;b29a7d0fe280489299b49eaad5f40a70&quot;,&quot;92208986af084f33aadb7644ef005d61&quot;,&quot;b36b0047196b420d95756bf399f8da81&quot;,&quot;831ec5fcdb58469bb54c4ec40beb3849&quot;,&quot;6e2ffa802eb1436ba06713762aacf1ea&quot;,&quot;d4a5ca16b21f489eb3865d41d56a0d53&quot;,&quot;3e1aadd6f8f947f9b1072c48d430cffc&quot;,&quot;d065caa0f6354e688742b9b7ae60970b&quot;]}"
id="FZQV9EQTckGD" data-outputId="a5093214-444c-42c8-f55d-1aece24039c9">
<div class="sourceCode" id="cb28"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> TrainingArguments</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> trl <span class="im">import</span> SFTTrainer</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Training Arguments</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>training_args <span class="op">=</span> TrainingArguments(</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    output_dir<span class="op">=</span><span class="st">&quot;gemma_enron_summarizer&quot;</span>,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    per_device_train_batch_size<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    gradient_accumulation_steps<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    learning_rate<span class="op">=</span><span class="fl">2e-4</span>,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    max_steps<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    logging_steps<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    fp16<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the Trainer</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="co"># - `args` takes the TrainingArguments object.</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="co"># - Other SFT-specific arguments are passed directly to the trainer.</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>trainer <span class="op">=</span> SFTTrainer(</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>model,</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    tokenizer<span class="op">=</span>tokenizer,</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    args<span class="op">=</span>training_args,</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    train_dataset<span class="op">=</span>fine_tuning_dataset,</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    peft_config<span class="op">=</span>peft_config,</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    dataset_text_field<span class="op">=</span><span class="st">&quot;text&quot;</span>,</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    max_seq_length<span class="op">=</span><span class="dv">512</span>,</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Start Training</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>trainer.train()</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">Fine-tuning complete.&quot;</span>)</span></code></pre></div>
<div class="output stream stderr">
<pre><code>/usr/local/lib/python3.12/dist-packages/huggingface_hub/utils/_deprecation.py:100: FutureWarning: Deprecated argument(s) used in &#39;__init__&#39;: dataset_text_field, max_seq_length. Will not be supported from version &#39;0.13.0&#39;.

Deprecated positional argument(s) used in SFTTrainer, please use the SFTConfig to set these arguments instead.
  warnings.warn(message, FutureWarning)
/usr/local/lib/python3.12/dist-packages/trl/trainer/sft_trainer.py:300: UserWarning: You passed a `max_seq_length` argument to the SFTTrainer, the value you passed will override the one in the `SFTConfig`.
  warnings.warn(
/usr/local/lib/python3.12/dist-packages/trl/trainer/sft_trainer.py:328: UserWarning: You passed a `dataset_text_field` argument to the SFTTrainer, the value you passed will override the one in the `SFTConfig`.
  warnings.warn(
</code></pre>
</div>
<div class="output display_data">
<div class="sourceCode" id="cb30"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;model_id&quot;</span><span class="fu">:</span><span class="st">&quot;3b12a484675e4cfcb626cae7f8e950af&quot;</span><span class="fu">,</span><span class="dt">&quot;version_major&quot;</span><span class="fu">:</span><span class="dv">2</span><span class="fu">,</span><span class="dt">&quot;version_minor&quot;</span><span class="fu">:</span><span class="dv">0</span><span class="fu">}</span></span></code></pre></div>
</div>
<div class="output stream stderr">
<pre><code>/usr/local/lib/python3.12/dist-packages/trl/trainer/sft_trainer.py:403: UserWarning: You passed a processing_class with `padding_side` not equal to `right` to the SFTTrainer. This might lead to some unexpected behaviour due to overflow issues when training a model in half-precision. You might consider adding `processing_class.padding_side = &#39;right&#39;` to your code.
  warnings.warn(
/usr/local/lib/python3.12/dist-packages/notebook/notebookapp.py:191: SyntaxWarning: invalid escape sequence &#39;\/&#39;
  | |_| | &#39;_ \/ _` / _` |  _/ -_)
</code></pre>
</div>
<div class="output display_data">
<pre><code>&lt;IPython.core.display.Javascript object&gt;</code></pre>
</div>
<div class="output stream stderr">
<pre><code>wandb: Logging into wandb.ai. (Learn how to deploy a W&amp;B server locally: https://wandb.me/wandb-server)
wandb: You can find your API key in your browser here: https://wandb.ai/authorize?ref=models
wandb: Paste an API key from your profile and hit enter:</code></pre>
</div>
<div class="output stream stdout">
<pre><code> ··········
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>wandb: WARNING If you&#39;re specifying your api key in code, ensure this code is not shared publicly.
wandb: WARNING Consider setting the WANDB_API_KEY environment variable, or running `wandb login` from the command line.
wandb: No netrc file found, creating one.
wandb: Appending key for api.wandb.ai to your netrc file: /root/.netrc
wandb: Currently logged in as: khojieditor (khojieditor-root) to https://api.wandb.ai. Use `wandb login --relogin` to force relogin
</code></pre>
</div>
<div class="output display_data">
Tracking run with wandb version 0.21.1
</div>
<div class="output display_data">
Run data is saved locally in <code>/content/wandb/run-20250825_085917-d1o6d4ct</code>
</div>
<div class="output display_data">
Syncing run <strong><a href='https://wandb.ai/khojieditor-root/huggingface/runs/d1o6d4ct' target="_blank">gallant-lion-3</a></strong> to <a href='https://wandb.ai/khojieditor-root/huggingface' target="_blank">Weights & Biases</a> (<a href='https://wandb.me/developer-guide' target="_blank">docs</a>)<br>
</div>
<div class="output display_data">
 View project at <a href='https://wandb.ai/khojieditor-root/huggingface' target="_blank">https://wandb.ai/khojieditor-root/huggingface</a>
</div>
<div class="output display_data">
 View run at <a href='https://wandb.ai/khojieditor-root/huggingface/runs/d1o6d4ct' target="_blank">https://wandb.ai/khojieditor-root/huggingface/runs/d1o6d4ct</a>
</div>
<div class="output display_data">

    <div>
      
      <progress value='100' max='100' style='width:300px; height:20px; vertical-align: middle;'></progress>
      [100/100 05:35, Epoch 0/1]
    </div>
    <table border="1" class="dataframe">
  <thead>
 <tr style="text-align: left;">
      <th>Step</th>
      <th>Training Loss</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>10</td>
      <td>4.063500</td>
    </tr>
    <tr>
      <td>20</td>
      <td>3.465500</td>
    </tr>
    <tr>
      <td>30</td>
      <td>3.104900</td>
    </tr>
    <tr>
      <td>40</td>
      <td>2.854700</td>
    </tr>
    <tr>
      <td>50</td>
      <td>2.828400</td>
    </tr>
    <tr>
      <td>60</td>
      <td>2.816000</td>
    </tr>
    <tr>
      <td>70</td>
      <td>2.753200</td>
    </tr>
    <tr>
      <td>80</td>
      <td>2.693600</td>
    </tr>
    <tr>
      <td>90</td>
      <td>2.764800</td>
    </tr>
    <tr>
      <td>100</td>
      <td>2.580500</td>
    </tr>
  </tbody>
</table><p>
</div>
<div class="output stream stdout">
<pre><code>
Fine-tuning complete.
</code></pre>
</div>
</div>
<section id="evaluate-the-fine-tuned-model" class="cell markdown"
id="BCL0wf7Bc2Vn">
<h2>Evaluate the Fine-Tuned Model</h2>
</section>
<div class="cell code" data-execution_count="14"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="B0jSIBGdebjk" data-outputId="c6a05d4c-67f8-471d-c81b-d60303c83939">
<div class="sourceCode" id="cb37"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select a test email from our parsed data that wasn&#39;t used for training.</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>test_email_body <span class="op">=</span> df_final.iloc[<span class="dv">6000</span>][<span class="st">&#39;body&#39;</span>].replace(<span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>, <span class="st">&#39; &#39;</span>).replace(<span class="st">&#39;</span><span class="ch">\r</span><span class="st">&#39;</span>, <span class="st">&#39; &#39;</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> <span class="ss">f&quot;Summarize the following email: </span><span class="sc">{</span>test_email_body<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate Summary with Fine-Tuned Model</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>input_text <span class="op">=</span> <span class="ss">f&quot;&lt;s&gt;[INST] </span><span class="sc">{</span>prompt<span class="sc">}</span><span class="ss"> [/INST]&quot;</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>inputs <span class="op">=</span> tokenizer(input_text, return_tensors<span class="op">=</span><span class="st">&quot;pt&quot;</span>).to(<span class="st">&quot;cuda&quot;</span>)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">Generating summary with our FINE-TUNED model...&quot;</span>)</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>outputs <span class="op">=</span> model.generate(<span class="op">**</span>inputs, max_new_tokens<span class="op">=</span><span class="dv">150</span>)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>summary_finetuned <span class="op">=</span> tokenizer.decode(outputs[<span class="dv">0</span>], skip_special_tokens<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Display Results ---</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">--- ORIGINAL EMAIL ---&quot;</span>)</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(test_email_body)</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">--- GENERATED SUMMARY (Fine-Tuned Model) ---&quot;</span>)</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(summary_finetuned.split(<span class="st">&quot;[/INST]&quot;</span>)[<span class="op">-</span><span class="dv">1</span>].strip())</span></code></pre></div>
<div class="output stream stdout">
<pre><code>
Generating summary with our FINE-TUNED model...

--- ORIGINAL EMAIL ---
The information contained herein is based on sources that we believe to be reliable, but we do not represent that it is accurate or complete.  Nothing contained herein should be considered as an offer to sell or a solicitation of an offer to buy any financial instruments discussed herein.  Any opinions expressed herein are solely those of the author.  As such, they may differ in material respects from those of, or expressed or published by on behalf of Carr Futures or its officers, directors, employees or affiliates.  , 2001 Carr Futures   The charts are now available on the web by clicking on the hot link(s) contained in this email. If for any reason you are unable to receive the charts via the web, please contact me via email and I will email the charts to you as attachments.   Crude     http://www.carrfut.com/research/Energy1/crude41.pdf Natural Gas     http://www.carrfut.com/research/Energy1/ngas41.pdf Distillate     http://www.carrfut.com/research/Energy1/hoil41.pdf Unleaded     http://www.carrfut.com/research/Energy1/unlded41.pdf  Nat Gas Strip Matrix http://www.carrfut.com/research/Energy1/StripmatrixNG41.pdf Nat Gas Spread Matrix http://www.carrfut.com/research/Energy1/SpreadmatrixNG41.pdf  Crude and Products Spread Matrix http://www.carrfut.com/research/Energy1/SpreadmatrixCL41.pdf      Carr Futures 150 S. Wacker Dr., Suite 1500 Chicago, IL 60606  USA Tel:  312-368-6149 Fax:  312-368-2281 soblander@carrfut.com http://www.carrfut.com

--- GENERATED SUMMARY (Fine-Tuned Model) ---
&lt;/s&gt;
</code></pre>
</div>
</div>
<section id="business-action-plan--interpretation" class="cell markdown"
id="hR8RxvBqen2t">
<h2>Business Action Plan &amp; Interpretation</h2>
</section>
<div class="cell markdown" id="NVNpFDZ8e0av">
<ul>
<li><strong>Performance:</strong> The "after" summary from our
fine-tuned model is expected to be much more coherent, relevant, and
concise. It has learned the specific task of extracting key information
from the Enron email format.</li>
<li><strong>Application:</strong> This fine-tuned model is now a
specialized Business Intelligence assistant. It can be integrated into
workflows to:
<ul>
<li><strong>Automate Reporting:</strong> Automatically generate daily or
weekly summaries of key communications for executives.</li>
<li><strong>Enhance Search:</strong> Instead of just keyword search,
employees could ask natural language questions about the content of the
email archive (e.g., "What were the main points of the Q4 planning
emails?").</li>
<li><strong>Compliance and Legal:</strong> Quickly summarize vast
numbers of emails for legal discovery or compliance checks, saving
thousands of hours of manual labor.</li>
</ul></li>
</ul>
<p>This project demonstrates how a general-purpose LLM can be
transformed into a high-value, specialized business tool through
efficient fine-tuning.</p>
</div>
<div class="cell code" id="P5UYO535e2F2">
<div class="sourceCode" id="cb39"><pre
class="sourceCode python"><code class="sourceCode python"></code></pre></div>
</div>
</body>
</html>
